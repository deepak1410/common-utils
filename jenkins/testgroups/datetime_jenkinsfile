pipeline {
  agent any
  stages {

    stage("Build") {
      steps() {
        sh "mvn clean package -B -DskipTests"
      }
    }

    stage("Test") {
      steps() {
        script {
            try {
                sh "mvn test -Dtest='com.dpk.datetime.**.*'"
            } catch (ex) {
                echo "Got some test failures, the pipeline will be marked unstable."
                currentBuild.result = 'UNSTABLE'

                sh '''
                    def testResult = build.testResultAction
                      if ( testResult != null ) {
                        def testsTotal = testResult.totalCount
                        def testsFailed = testResult.failCount
                        def testsSkipped = testResult.skipCount
                        def testsPassed = testsTotal - testsFailed - testsSkipped

                        def subject = build.externalizableId + " : Tests passed " + testsPassed + ", out of " + testsTotal
                        msg.setSubject(subject)
                        echo "Test report:" + subject
                      }

                '''
            }
        }
      }
      post {
        always {
          junit "target/surefire-reports/*.xml"
        }
      }
    }

  }
}